{% extends 'partials/main.html' %}

{% load static %}

{% block content %}
<style>
   /* Gallery Styles */
   .gallery-main {
      background-color: var(--bg-light);
      min-height: calc(100vh - 200px);
      padding: 3rem 0;
   }

   .gallery-title {
      color: var(--text-dark);
      font-weight: 800;
      font-size: 1.75rem;
      letter-spacing: -0.5px;
      margin-bottom: 1.5rem;
   }

   .filter-section {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--card-border);
      position: sticky;
      top: 100px;
   }

   .filter-group {
      margin-bottom: 2rem;
   }

   .filter-group:last-child {
      margin-bottom: 0;
   }

   .filter-title {
      color: var(--text-dark);
      font-weight: 700;
      font-size: 0.95rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      border: none;
      background: none;
      padding: 0;
      width: 100%;
      margin-bottom: 1rem;
   }

   .filter-title i {
      font-size: 0.8rem;
      transition: transform 0.3s ease;
   }

   .filter-title:not(.collapsed) i {
      transform: rotate(180deg);
   }

   .filter-option {
      padding: 6px 0;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-muted);
      font-weight: 500;
      font-size: 0.9rem;
      transition: color 0.2s ease;
   }

   .filter-option:hover {
      color: var(--accent);
   }

   .filter-option input {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
      cursor: pointer;
   }

   /* Modern Product Card */
   .product-card {
      background: white;
      border-radius: 20px;
      overflow: hidden;
      border: 1px solid var(--card-border);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      height: 100%;
      display: flex;
      flex-direction: column;
   }

   .product-card:hover {
      transform: translateY(-8px);
      box-shadow: var(--shadow-lg);
      border-color: var(--accent);
   }

   .product-image {
      position: relative;
      aspect-ratio: 1/1;
      overflow: hidden;
      background: #f1f5f9;
      display: flex;
      align-items: center;
      justify-content: center;
   }

   .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s ease;
   }

   .product-card:hover .product-image img {
      transform: scale(1.1);
   }

   .product-info {
      padding: 1.5rem;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
   }

   .product-meta {
      margin-bottom: 10px;
   }

   .product-name {
      color: var(--text-dark);
      font-weight: 700;
      font-size: 1rem;
      margin: 0;
      line-height: 1.4;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
   }

   /* Correctly handles 2 lines */


   .product-price-wrapper {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 15px;
   }

   .product-price {
      color: var(--accent);
      font-weight: 800;
      font-size: 1.25rem;
   }

   .btn-view {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: var(--accent-soft);
      color: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
   }

   .product-card:hover .btn-view {
      background: var(--accent);
      color: white;
   }
</style>

<!-- Gallery Section -->
<div class="gallery-main py-5">
   <div class="container-fluid">
      <div class="row px-lg-4">
         <div class="col-lg-2">
            <div class="filter-section">
               <h4 class="mb-4" style="font-weight: 800; font-size: 1.2rem;">Filters</h4>

               <!-- Kategoriler -->
               <div class="filter-group">
                  <button type="button" class="filter-title" data-bs-toggle="collapse"
                     data-bs-target="#categoryFilters">
                     <span>Categories</span>
                     <i class="bi bi-chevron-down"></i>
                  </button>
                  <div id="categoryFilters" class="collapse show">
                     {% for category in subcategories %}
                     <div class="filter-option">
                        <input type="radio" value="{{category.slug}}" name="shoesCategory" id="category-{{category.id}}"
                           onclick="filterShoes('{{category.slug}}')">
                        <label class="pointer" for="category-{{category.id}}">{{category.title}}</label>
                     </div>
                     {% endfor %}
                  </div>
               </div>

               <!-- Height -->
               <div class="filter-group">
                  <button type="button" class="filter-title collapsed" data-bs-toggle="collapse"
                     data-bs-target="#heightFilters">
                     <span>Shoe Height</span>
                     <i class="bi bi-chevron-down"></i>
                  </button>
                  <div id="heightFilters" class="collapse">
                     {% for Shoe_Height in Shoe_Heights %}
                     <div class="filter-option">
                        <input type="radio" value="{{Shoe_Height.slug}}" name="ShoeHeight"
                           id="Shoe_Height-{{Shoe_Height.id}}" onclick="filterShoes('{{category.slug}}')">
                        <label class="pointer" for="Shoe_Height-{{Shoe_Height.id}}">{{Shoe_Height.name}}</label>
                     </div>
                     {% endfor %}
                  </div>
               </div>

               <!-- Color -->
               <div class="filter-group">
                  <button type="button" class="filter-title collapsed" data-bs-toggle="collapse"
                     data-bs-target="#colorFilters">
                     <span>Colors</span>
                     <i class="bi bi-chevron-down"></i>
                  </button>
                  <div id="colorFilters" class="collapse">
                     <div class="row g-2">
                        {% for Color in Colors %}
                        <div class="col-6">
                           <div class="filter-option">
                              <input name="shoesColor" value="{{Color.slug}}" type="radio" id="Color-{{Color.id}}"
                                 onclick="filterShoes('{{category.slug}}')">
                              <label class="pointer" for="Color-{{Color.id}}">{{Color.name}}</label>
                           </div>
                        </div>
                        {% endfor %}
                     </div>
                  </div>
               </div>

               <!-- Size -->
               <div class="filter-group">
                  <button type="button" class="filter-title collapsed" data-bs-toggle="collapse"
                     data-bs-target="#sizeFilters">
                     <span>Sizes</span>
                     <i class="bi bi-chevron-down"></i>
                  </button>
                  <div id="sizeFilters" class="collapse">
                     <div class="row g-2">
                        {% for Shoes_Number in Shoes_Numbers %}
                        <div class="col-4">
                           <input type="radio" class="btn-check" value="{{Shoes_Number.slug}}" name="shoesNumber"
                              id="num-{{Shoes_Number.id}}" onclick="filterShoes('{{category.slug}}')">
                           <label class="btn btn-outline-light text-dark border-0 p-2 fs-6 fw-bold w-100"
                              for="num-{{Shoes_Number.id}}" style="background: #f1f5f9;">{{Shoes_Number}}</label>
                        </div>
                        {% endfor %}
                     </div>
                  </div>
               </div>

               <!-- Markalar -->
               <div class="filter-group">
                  <button type="button" class="filter-title collapsed" data-bs-toggle="collapse"
                     data-bs-target="#brandFilters">
                     <span>Brands</span>
                     <i class="bi bi-chevron-down"></i>
                  </button>
                  <div id="brandFilters" class="collapse">
                     {% for brand in brands %}
                     <div class="filter-option">
                        <input class="form-check-input" type="radio" name="brand" value="{{brand.name}}"
                           id="brand-{{brand.id}}" onclick="filterShoes('{{category.slug}}')">
                        <label class="form-check-label pointer" for="brand-{{brand.id}}">{{brand.name}}</label>
                     </div>
                     {% endfor %}
                  </div>
               </div>
            </div>
         </div>

         <!-- Products Section -->
         <div class="col-lg-10">
            <div class="d-flex justify-content-between align-items-end mb-4">
               <h2 class="gallery-title mb-0">{{ category.title }} <span class="text-muted fw-normal fs-5">(<span
                        id="countS">{{shoes_all.count}}</span>) products</span></h2>
            </div>

            <div class="row g-4" id="shoes-container">
               {% for shoes in shoes_all %}
               <div class="col-xl-4 col-md-6">
                  <a href="{% url 'product' shoes.id %}" class="text-decoration-none">
                     <div class="product-card">
                        <div class="product-image">
                           <img src="{{shoes.image.url}}" alt="{{shoes.name}}">
                        </div>
                        <div class="product-info">
                           <h6 class="product-name">{{shoes.name}}</h6>
                           <div class="product-price-wrapper">
                              <span class="product-price">{{shoes.price}}₺</span>
                              <div class="btn-view"><i class="bi bi-arrow-right"></i></div>
                           </div>
                        </div>
                     </div>
                  </a>
               </div>
               {% endfor %}
            </div>
         </div>
      </div>
   </div>
</div> <!-- col-lg-10 end -->
</div> <!-- row end -->
</div> <!-- container-fluid end -->
</div> <!-- gallery-main end -->
<script>
   function filterShoes(category) {

      var Shoe_Height_filterValues = [];
      $("input[name='ShoeHeight']:checked").each(function () {
         Shoe_Height_filterValues.push($(this).val());
      });

      var shoes_color_filterValues = [];
      $("input[name='shoesColor']:checked").each(function () {
         shoes_color_filterValues.push($(this).val());
      });

      var shoes_number_filterValues = [];
      $("input[name='shoesNumber']:checked").each(function () {
         shoes_number_filterValues.push($(this).val());
      });

      var shoes_brand_filterValues = [];
      $("input[name='brand']:checked").each(function () {
         shoes_brand_filterValues.push($(this).val());
      });

      var url = "{% url 'filter_shoes' %}?category_name=" + category;
      Shoe_Height_filterValues.forEach(val => url += "&shoe_height_filters=" + val);
      shoes_color_filterValues.forEach(val => url += "&shoes_color_filters=" + val);
      shoes_number_filterValues.forEach(val => url += "&shoes_number_filters=" + val);
      shoes_brand_filterValues.forEach(val => url += "&shoes_brand_filters=" + val);
      var shoesHtml = '';
      $.ajax({
         url: url,
         type: 'GET',
         success: function (response) {
            $('#shoes-container').empty();
            $('#countS').html(response.shoes_count);
            response.shoes.forEach(function (shoe) {
               var shoeUrl = `/shoes/product/${shoe.id}`;
               shoesHtml += `
                     <div class="col-xl-4 col-md-6">
                        <a href="${shoeUrl}" class="text-decoration-none">
                           <div class="product-card">
                              <div class="product-image">
                                 <img src="/media/${shoe.image}" alt="${shoe.name}">
                              </div>
                              <div class="product-info">
                                 <h6 class="product-name">${shoe.name}</h6>
                                 <div class="product-price-wrapper">
                                    <span class="product-price">${shoe.price}₺</span>
                                    <div class="btn-view"><i class="bi bi-arrow-right"></i></div>
                                 </div>
                              </div>
                           </div>
                        </a>
                     </div>`;
            });
            $('#shoes-container').html(shoesHtml);
         }
      });
   }
</script>
<script>
   // Use Bootstrap Collapse API to reliably toggle sections and flip chevrons
   (function () {
      document.querySelectorAll('.filter-title').forEach(function (btn) {
         var targetSelector = btn.getAttribute('data-bs-target');
         if (!targetSelector) return;
         var target = document.querySelector(targetSelector);
         var icon = btn.querySelector('i');
         if (!target || !icon) return;

         // initialize icon based on current state
         if (target.classList.contains('show')) {
            icon.classList.remove('bi-chevron-down'); icon.classList.add('bi-chevron-up');
         } else {
            icon.classList.remove('bi-chevron-up'); icon.classList.add('bi-chevron-down');
         }

         // create/get Bootstrap Collapse instance (do not auto-toggle on creation)
         var collapseInstance = bootstrap.Collapse.getOrCreateInstance(target, { toggle: false });

         // toggle via API when title clicked
         btn.addEventListener('click', function (e) {
            collapseInstance.toggle();
         });

         // update icon when collapse finishes
         target.addEventListener('shown.bs.collapse', function () {
            icon.classList.remove('bi-chevron-down'); icon.classList.add('bi-chevron-up');
         });
         target.addEventListener('hidden.bs.collapse', function () {
            icon.classList.remove('bi-chevron-up'); icon.classList.add('bi-chevron-down');
         });
      });
   })();
</script>

{% endblock %}